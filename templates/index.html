<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicate File Manager</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <style>
        /* Style for the draggable folder list */
        #folderList {
            border: 1px solid #ccc;
            padding: 5px;
            min-height: 50px;
        }
        #folderList .folderItem {
            padding: 5px;
            margin: 2px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            cursor: move;
        }

        /* Style for duplicate group separators */
        .group-separator {
            border-top: 2px solid #007bff; /* Blue color to match Bootstrap */
            margin-top: 10px;
            padding-top: 10px;
        }

        /* Highlight row for deletion */
        .delete-highlight {
            background-color: #ffcccc; /* Light red */
        }

        /* Style for the unique files separator */
        .unique-separator {
            border-top: 3px solid #28a745; /* Green color for differentiation */
            margin-top: 15px;
            padding-top: 15px;
            font-weight: bold;
        }
           /* Styles for the group status */
        .group-status {
            font-weight: bold;
            padding: 5px;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        .group-status.multiple {
            background-color: #ffcccc; /* Light red for multiple duplicates */
        }

        .group-status.single {
            background-color: #ccffcc; /* Light green for single file */
        }

        .group-status.all-delete {
            background-color: #ffffcc; /* Light yellow for all to delete */
        }
        /* Style to further separate groups */
        .extra-separator {
            border-top: 5px solid #ff9800; /* A more noticeable orange color */
            margin-top: 20px;
            padding-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Duplicate File Manager</h1>

        <div class="form-group">
            <label for="rootDirectory">Root Directory:</label>
            <input type="text" class="form-control" id="rootDirectory" placeholder="Enter root directory">
            <button class="btn btn-primary" onclick="setRootDirectory()">Set Directory</button>
        </div>

        <div>
            <label>Drag and Drop Folder Priority:</label>
            <div id="folderList">
                <!-- Folder list will be populated here -->
            </div>
            <button class="btn btn-info" onclick="applyFolderPriority()">Apply Priority</button>
        </div>

        <button class="btn btn-success" onclick="listFiles()">List Files and Find Duplicates</button>

        <table class="table">
            <thead>
                <tr>
                    <th>File Name</th>
                    <th>Directory Path</th>
                    <th>Preview</th>
                    <th>File Size (bytes)</th>
                    <th>Last Modified</th>
                    <th>Duplicate Group</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody id="fileTableBody">
            </tbody>
        </table>

        <button class="btn btn-danger" onclick="deleteFiles()">Delete Marked Files</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        let fileList = [];
        let groupStatuses = {}; // Store group statuses


        function setRootDirectory() {
            const rootDirectory = $('#rootDirectory').val();
            $.ajax({
                url: '/set_root_directory',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ rootDirectory: rootDirectory }),
                success: function (response) {
                    alert(response.message);
                },
                error: function (error) {
                    console.error('Error setting root directory:', error);
                }
            });
        }

        function listFiles() {
            $.ajax({
                url: '/list_files',
                type: 'GET',
                success: function (response) {
                       console.log("Raw JSON response:", response); // add this line
                    if (response.status === 'success') {
                        fileList = response.file_list;
                        populateTable(fileList);
                        populateFolderList(fileList); // Populate folder list
                    } else {
                        alert(response.message);
                    }
                },
                error: function (error) {
                    console.error('Error listing files:', error);
                }
            });
        }

      function populateTable(fileList) {
          const tableBody = $('#fileTableBody');
          tableBody.empty();

          let currentGroup = null;
          let uniqueSeparatorAdded = false;

          fileList.forEach(function (file, index) {
              //Group and check what's needed to separate it
              if (file["Duplicate Group"] !== null && file["Duplicate Group"] !== currentGroup) {
                  const groupStatus = groupStatuses[file["Duplicate Group"]] || "Multiple Duplicates";
                  const separatorRow = `
                      <tr class="group-separator">
                          <td colspan="7">
                              Duplicate Group ${file["Duplicate Group"]} -
                              <span class="group-status ${getGroupStatusClass(groupStatus)}">${groupStatus}</span>
                          </td>
                      </tr>`;
                  tableBody.append(separatorRow);
                  currentGroup = file["Duplicate Group"];
              }
              //If duplicate has been run, it will not have it
              if (file["Duplicate Group"] === null && !uniqueSeparatorAdded) {
                  const uniqueSeparatorRow = `<tr class="unique-separator"><td colspan="7">Unique Files</td></tr>`;
                  tableBody.append(uniqueSeparatorRow);
                  uniqueSeparatorAdded = true;
              }
              //This creates the checkbook, remember 2 different quote
              const row = `
                  <tr class="${file["Delete"] === "Yes" ? "delete-highlight" : ""}">
                      <td>${file["File Name"]}</td>
                      <td>${file["Directory Path"]}</td>
                      <td><img src="/get_image/${file["File Path"]}" alt="Preview" style="width: 50px; height: 50px;"></td>
                      <td>${file["File Size (bytes)"]}</td>
                      <td>${file["Last Modified"]}</td>
                      <td>${file["Duplicate Group"] || ''}</td>
                      <td>
                          <input type="checkbox" id="delete-${index}" ${file["Delete"] === "Yes" ? "checked" : ""} onchange="updateFile('${file["File Path"]}')">
                      </td>
                  </tr>`;
              tableBody.append(row);
          });
      }
          function getGroupStatusClass(status) {
            switch (status) {
                case "Multiple Duplicates":
                    return "multiple";
                case "Only 1 file":
                    return "single";
                case "All to be Deleted":
                    return "all-delete";
                default:
                    return "";
            }
        }
        function updateFile(filePath) {
            const index = fileList.findIndex(file => file["File Path"] === filePath);
            const deleteValue = $(`#delete-${index}`).is(":checked") ? "Yes" : "No";
            const row = $(`#delete-${index}`).closest('tr');

            $.ajax({
                url: '/update_file',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ filePath: filePath, delete: deleteValue }),
                  success: function (response) {
                       console.log("Update SUCCESS JSON response:", response);
                     groupStatuses = response.group_statuses;
                      fileList = response.file_list
                    populateTable(fileList);

                  },
                error: function (error) {
                    console.error('Error updating file:', error);
                }
            });
        }

        function populateFolderList(fileList) {
            const folderListDiv = $('#folderList');
            folderListDiv.empty();
            const folders = [...new Set(fileList.map(file => file["Directory Path"]))]; // Get unique folders

            folders.forEach(folder => {
                const folderItem = `<div class="folderItem" data-folder="${folder}">${folder}</div>`;
                folderListDiv.append(folderItem);
            });

            // Make the folder list sortable
            $("#folderList").sortable({
                cursor: "move"
            });
            $("#folderList").disableSelection();
        }

        function applyFolderPriority() {
          const priorityFolders = $('#folderList .folderItem').map(function() {
              return $(this).data('folder');
          }).get();

          $.ajax({
              url: '/apply_folder_priority',
              type: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ priorityFolders: priorityFolders }),
                  success: function (response) {
                       console.log("applyFolderPriority SUCCESS JSON response:", response);
                   groupStatuses = response.group_statuses;
                    fileList = response.file_list
                       populateTable(fileList);

              },
              error: function (error) {
                  console.error('Error applying folder priority:', error);
              }
          });
      }

        function deleteFiles() {
            $.ajax({
                url: '/delete_files',
                type: 'GET',
                success: function (response) {
                    alert(response.message);
                    listFiles(); // Refresh the file list after deleting
                },
                error: function (error) {
                    console.error('Error deleting files:', error);
                }
            });
        }
    </script>
</body>
</html>